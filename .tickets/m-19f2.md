---
id: m-19f2
status: closed
deps: []
links: []
created: 2026-01-31T16:04:17Z
type: bug
priority: 2
assignee: Brian Romanko
---
# Add double-booking protection

Two concurrent POST /api/book requests for the same time slot both succeed. No database-level overlap constraint and no application-level check-then-insert within a transaction. Need to verify slot availability within a transaction before inserting a booking.


## Notes

**2026-02-08T19:34:20Z**

Spec-writing phase surfaced this as a concrete bug: /api/book does not perform booking-time slot revalidation and may allow stale-slot/double-booking under race conditions.

**2026-02-08T19:40:01Z**

Implemented transactional slot conflict protection with BEGIN IMMEDIATE + overlap check via insertBookingIfSlotAvailable; /api/book now returns 409 when slot is already taken. Added DB tests for overlap rejection and adjacent booking acceptance. Verified with selfci check.

**2026-02-08T19:46:32Z**

Adjusted conflict payload to include machine code for spec alignment: { error: "Selected slot is no longer available.", code: "slot_unavailable" }. Also added booking-frontend handling for HTTP 409 to return user to slot selection and refresh slots.
