---
id: m-e860
status: closed
deps: []
links: []
created: 2026-01-31T15:37:31Z
type: feature
priority: 2
assignee: Brian Romanko
---
# Add declarative database migration system

Set up a declarative database migration system for managing SQLite schema changes. Evaluate existing tools (e.g. Atlas, dbmate, goose) that support a declarative approach where you define the desired schema state and the tool computes the diff. Must integrate with the Nix-based dev environment and support SQLite.


## Notes

**2026-02-06T20:46:18Z**

Implemented Atlas as the database migration tool. Approach: Atlas is used at dev time to generate versioned SQL migration files from a declarative schema.sql. At runtime, a lightweight F# migration runner (Migrations.fs) reads the SQL files and applies pending ones, tracking versions in an atlas_schema_revisions table. No runtime dependency on the atlas binary. Changes: added atlas to Nix devShell, extracted schema.sql, generated initial migration, added Migrations.fs, updated Database.fs and Program.fs, updated tests.

**2026-02-06T21:17:09Z**

Post-review improvements: added atlas.sum checksum verification (integrity + per-file hash), 14 dedicated migration tests, explicit transaction rollback, removed naive stripComments (SQLite handles natively), replaced DateTime.UtcNow with NodaTime IClock, improved test assertions (failtestf, revisions count check).
